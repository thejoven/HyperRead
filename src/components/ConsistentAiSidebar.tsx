'use client'

import { useState, useEffect, useRef } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { X, Send, Bot, User, Settings, Copy, Check, Trash2, FileText, MessageSquare, Layers, Clock, History } from 'lucide-react'
import { createAiService } from '@/lib/ai-service'
import { conversationStorage } from '@/lib/conversation-storage'

interface ConsistentAiSidebarProps {
  isOpen: boolean
  onClose: () => void
  currentDocument?: {
    fileName: string
    content: string
    filePath: string
  }
}

interface Message {
  id: string
  role: 'user' | 'assistant' | 'system'
  content: string
  timestamp: Date
}

interface AiConfig {
  provider: string
  apiKey: string
  apiUrl: string
  model: string
  isConfigured: boolean
}

export default function ConsistentAiSidebar({ isOpen, onClose, currentDocument }: ConsistentAiSidebarProps) {
  const [messages, setMessages] = useState<Message[]>([])
  const [inputValue, setInputValue] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [aiConfig, setAiConfig] = useState<AiConfig>({
    provider: 'openai',
    apiKey: '',
    apiUrl: '',
    model: '',
    isConfigured: false
  })
  const [copiedMessageId, setCopiedMessageId] = useState<string | null>(null)
  const [isProcessingLongDoc, setIsProcessingLongDoc] = useState(false)
  const [processingProgress, setProcessingProgress] = useState({ completed: 0, total: 0 })
  const messagesEndRef = useRef<HTMLDivElement>(null)
  const inputRef = useRef<HTMLInputElement>(null)
  const previousDocumentRef = useRef<typeof currentDocument>(null)

  // Âä†ËΩΩ AI ÈÖçÁΩÆ
  useEffect(() => {
    const savedConfig = localStorage.getItem('ai-config')
    if (savedConfig) {
      try {
        const config = JSON.parse(savedConfig)
        setAiConfig({
          ...config,
          isConfigured: !!(config.apiKey && config.model)
        })
      } catch (error) {
        console.error('Failed to load AI config:', error)
      }
    }
  }, [isOpen])

  // ‰øùÂ≠òÂΩìÂâçÊñáÊ°£ÂºïÁî®ÔºåÁî®‰∫éÂú®ÊñáÊ°£ÂàáÊç¢Êó∂‰øùÂ≠òÂØπËØù
  useEffect(() => {
    previousDocumentRef.current = currentDocument
  }, [currentDocument])

  // ÁªÑ‰ª∂Âç∏ËΩΩÊó∂‰øùÂ≠òÂØπËØùÂéÜÂè≤
  useEffect(() => {
    return () => {
      if (previousDocumentRef.current && messages.length > 0) {
        conversationStorage.saveConversation(
          previousDocumentRef.current.filePath,
          previousDocumentRef.current.fileName,
          messages,
          previousDocumentRef.current.content
        )
      }
    }
  }, [])

  // Â§ÑÁêÜÊñáÊ°£ÂàáÊç¢
  useEffect(() => {
    if (!isOpen) return

    if (currentDocument) {
      // Âä†ËΩΩÂΩìÂâçÊñáÊ°£ÁöÑÂØπËØùÂéÜÂè≤
      const savedMessages = conversationStorage.loadConversation(
        currentDocument.filePath,
        currentDocument.fileName,
        currentDocument.content
      )

      if (savedMessages.length > 0) {
        // Â¶ÇÊûúÊúâ‰øùÂ≠òÁöÑÂØπËØùÔºåÁõ¥Êé•Âä†ËΩΩ
        setMessages(savedMessages)
      } else {
        // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑÂØπËØùÔºåÂàõÂª∫Êñ∞ÁöÑÁ≥ªÁªüÊ∂àÊÅØ
        const systemMessage: Message = {
          id: 'system-init',
          role: 'system',
          content: `‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑÊñáÊ°£ÂàÜÊûêÂä©Êâã„ÄÇÂΩìÂâçÁî®Êà∑Ê≠£Âú®Êü•ÁúãÊñáÊ°£"${currentDocument.fileName}"„ÄÇ

ÊñáÊ°£ÂÜÖÂÆπÔºö
${currentDocument.content.substring(0, 3000)}${currentDocument.content.length > 3000 ? '...\n\n(ÊñáÊ°£ÂÜÖÂÆπÂ∑≤Êà™Êñ≠ÔºåÂ¶ÇÈúÄÊü•ÁúãÂÆåÊï¥ÂÜÖÂÆπËØ∑ÂëäËØâÁî®Êà∑)' : ''}

ËØ∑Âü∫‰∫éËøô‰∏™ÊñáÊ°£ÂÜÖÂÆπÊù•ÂõûÁ≠îÁî®Êà∑ÁöÑÈóÆÈ¢ò„ÄÇÂ¶ÇÊûúÁî®Êà∑ËØ¢ÈóÆÊñáÊ°£Áõ∏ÂÖ≥ÂÜÖÂÆπÔºåËØ∑ÂÖ∑‰ΩìÂºïÁî®ÊñáÊ°£‰∏≠ÁöÑÂÜÖÂÆπ„ÄÇ‰øùÊåÅÂõûÁ≠îÂáÜÁ°Æ„ÄÅÊúâÁî®‰∏îÂèãÂ•Ω„ÄÇ‰ΩøÁî®‰∏≠ÊñáÂõûÁ≠î„ÄÇ`,
          timestamp: new Date()
        }
        setMessages([systemMessage])
      }
    } else if (messages.length === 0) {
      // Ê≤°ÊúâÂΩìÂâçÊñáÊ°£‰∏îÊ≤°ÊúâÊ∂àÊÅØÊó∂ÔºåÂàõÂª∫ÈÄöÁî®Á≥ªÁªüÊ∂àÊÅØ
      const systemMessage: Message = {
        id: 'system-init',
        role: 'system',
        content: '‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑÊñáÊ°£ÂàÜÊûêÂä©Êâã„ÄÇÂ∏ÆÂä©Áî®Êà∑ÂàÜÊûêÊñáÊ°£ÂÜÖÂÆπ„ÄÅÂõûÁ≠îÊäÄÊúØÈóÆÈ¢ò„ÄÅÊèê‰æõÂª∫ËÆÆÁ≠â„ÄÇ‰øùÊåÅÂõûÁ≠îÂáÜÁ°Æ„ÄÅÊúâÁî®‰∏îÂèãÂ•Ω„ÄÇ‰ΩøÁî®‰∏≠ÊñáÂõûÁ≠î„ÄÇ',
        timestamp: new Date()
      }
      setMessages([systemMessage])
    }
  }, [isOpen, currentDocument?.filePath])

  // Ëá™Âä®‰øùÂ≠òÂØπËØùÂéÜÂè≤
  useEffect(() => {
    if (currentDocument && messages.length > 1) { // Ëá≥Â∞ëÊúâÁ≥ªÁªüÊ∂àÊÅØ+1Êù°ÂÖ∂‰ªñÊ∂àÊÅØÊâç‰øùÂ≠ò
      const timeoutId = setTimeout(() => {
        conversationStorage.saveConversation(
          currentDocument.filePath,
          currentDocument.fileName,
          messages,
          currentDocument.content
        )
      }, 2000) // 2ÁßíÂª∂Ëøü‰øùÂ≠òÔºåÈÅøÂÖçÈ¢ëÁπÅ‰øùÂ≠ò

      return () => clearTimeout(timeoutId)
    }
  }, [messages, currentDocument])

  // Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages])

  // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
  useEffect(() => {
    if (isOpen && inputRef.current) {
      setTimeout(() => {
        inputRef.current?.focus()
      }, 100)
    }
  }, [isOpen])

  const copyToClipboard = async (text: string, messageId: string) => {
    try {
      await navigator.clipboard.writeText(text)
      setCopiedMessageId(messageId)
      setTimeout(() => setCopiedMessageId(null), 2000)
    } catch (error) {
      console.error('Failed to copy to clipboard:', error)
    }
  }

  const sendMessage = async () => {
    if (!inputValue.trim() || isLoading || !aiConfig.isConfigured) return

    const userMessage: Message = {
      id: Date.now().toString(),
      role: 'user',
      content: inputValue.trim(),
      timestamp: new Date()
    }

    const updatedMessages = [...messages, userMessage]
    setMessages(updatedMessages)
    const originalQuestion = inputValue.trim()
    setInputValue('')
    setIsLoading(true)

    try {
      const aiService = createAiService(aiConfig)

      // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÈïøÊñáÊ°£Â§ÑÁêÜ
      const shouldUseLongDocProcessing = currentDocument &&
        currentDocument.content.length > 8000 &&
        (originalQuestion.includes('ÊÄªÁªì') || originalQuestion.includes('ÂàÜÊûê') || originalQuestion.includes('Ê¶ÇËø∞'))

      if (shouldUseLongDocProcessing) {
        await processLongDocument(aiService, originalQuestion)
      } else {
        // Â∏∏ËßÑÂ§ÑÁêÜ
        const aiMessages = updatedMessages.map(msg => ({
          role: msg.role,
          content: msg.content
        }))

        const aiResponse = await aiService.sendMessage(aiMessages)

        const assistantMessage: Message = {
          id: (Date.now() + 1).toString(),
          role: 'assistant',
          content: aiResponse,
          timestamp: new Date()
        }

        setMessages(prev => [...prev, assistantMessage])
      }
    } catch (error) {
      console.error('AI request failed:', error)
      const errorMessage: Message = {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: `Êä±Ê≠âÔºåAI ÊúçÂä°Âá∫Áé∞ÈîôËØØÔºö${error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'}„ÄÇËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËøûÊé•Âíå AI ÈÖçÁΩÆ„ÄÇ`,
        timestamp: new Date()
      }
      setMessages(prev => [...prev, errorMessage])
    } finally {
      setIsLoading(false)
    }
  }

  const processLongDocument = async (aiService: any, question: string) => {
    if (!currentDocument) return

    setIsProcessingLongDoc(true)
    setProcessingProgress({ completed: 0, total: 0 })

    // Ê∑ªÂä†Â§ÑÁêÜÁä∂ÊÄÅÊ∂àÊÅØ
    const statusMessage: Message = {
      id: `processing-${Date.now()}`,
      role: 'assistant',
      content: `üìÑ Ê£ÄÊµãÂà∞ÈïøÊñáÊ°£ (${Math.round(currentDocument.content.length / 1000)}kÂ≠óÁ¨¶)ÔºåÊ≠£Âú®ÂàÜÊÆµÂ§ÑÁêÜ...`,
      timestamp: new Date()
    }
    setMessages(prev => [...prev, statusMessage])

    try {
      // ÂàÜÊÆµÂ§ÑÁêÜ
      const chunks = aiService.splitDocument(currentDocument.content)
      setProcessingProgress({ completed: 0, total: chunks.length })

      // Êõ¥Êñ∞Áä∂ÊÄÅÊ∂àÊÅØ
      const updateMessage: Message = {
        id: `chunks-${Date.now()}`,
        role: 'assistant',
        content: `üîÑ Â∑≤ÂàÜÊàê ${chunks.length} ‰∏™ÁâáÊÆµÔºåÂºÄÂßãÂπ∂Ë°åÂ§ÑÁêÜ...`,
        timestamp: new Date()
      }
      setMessages(prev => [...prev, updateMessage])

      // Â§ÑÁêÜÂêÑ‰∏™ÁâáÊÆµ
      const tasks = await aiService.processDocumentChunks(
        chunks,
        'summarize',
        (progress) => {
          setProcessingProgress(progress)

          // Êõ¥Êñ∞ËøõÂ∫¶Ê∂àÊÅØ
          if (progress.currentTask) {
            const progressMessage: Message = {
              id: `progress-${Date.now()}`,
              role: 'assistant',
              content: `‚ö° Â§ÑÁêÜËøõÂ∫¶: ${progress.completed}/${progress.total} (Ê≠£Âú®Â§ÑÁêÜÁ¨¨${progress.currentTask.chunk.index + 1}ÈÉ®ÂàÜ)`,
              timestamp: new Date()
            }
            setMessages(prev => {
              // ÊõøÊç¢ÊúÄÂêé‰∏ÄÊù°ËøõÂ∫¶Ê∂àÊÅØ
              const filtered = prev.filter(m => !m.id.startsWith('progress-'))
              return [...filtered, progressMessage]
            })
          }
        }
      )

      // ÁªºÂêàÁªìÊûú
      const finalResult = await aiService.synthesizeResults(tasks, question)

      const finalMessage: Message = {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: finalResult,
        timestamp: new Date()
      }

      // Ê∏ÖÁêÜËøõÂ∫¶Ê∂àÊÅØÂπ∂Ê∑ªÂä†ÊúÄÁªàÁªìÊûú
      setMessages(prev => {
        const filtered = prev.filter(m =>
          !m.id.startsWith('processing-') &&
          !m.id.startsWith('chunks-') &&
          !m.id.startsWith('progress-')
        )
        return [...filtered, finalMessage]
      })

    } catch (error) {
      console.error('Long document processing failed:', error)
      const errorMessage: Message = {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: `‚ùå ÈïøÊñáÊ°£Â§ÑÁêÜÂ§±Ë¥•Ôºö${error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'}`,
        timestamp: new Date()
      }
      setMessages(prev => {
        const filtered = prev.filter(m =>
          !m.id.startsWith('processing-') &&
          !m.id.startsWith('chunks-') &&
          !m.id.startsWith('progress-')
        )
        return [...filtered, errorMessage]
      })
    } finally {
      setIsProcessingLongDoc(false)
      setProcessingProgress({ completed: 0, total: 0 })
    }
  }

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      sendMessage()
    }
  }

  const clearChat = () => {
    const systemMessage = messages.find(m => m.role === 'system')
    setMessages(systemMessage ? [systemMessage] : [])

    // Ê∏ÖÁ©∫‰øùÂ≠òÁöÑÂØπËØùÂéÜÂè≤
    if (currentDocument) {
      conversationStorage.deleteConversation(currentDocument.filePath)
    }
  }

  const displayMessages = messages.filter(m => m.role !== 'system')

  return (
    <div className={`fixed top-14 right-0 h-[calc(100vh-56px)] w-72 min-w-72 z-40 macos-sidebar flex flex-col border-l border-border transition-transform duration-300 ease-in-out ${
      isOpen ? 'translate-x-0' : 'translate-x-full'
    }`}>
      {/* Â§¥ÈÉ® - ‰∏éFileList‰øùÊåÅ‰∏ÄËá¥ */}
      <div className="px-2 py-2 border-b border-border/50 flex-shrink-0 bg-background/80">
        <div className="flex items-center gap-1">
          <div className="flex items-center gap-2 flex-1">
            {currentDocument && (
              <>
                <FileText className="h-3 w-3 text-muted-foreground" />
                <span className="text-xs text-muted-foreground truncate macos-text" title={currentDocument.fileName}>
                  {currentDocument.fileName}
                </span>
                {messages.length > 1 && (
                  <>
                    <span className="text-xs text-muted-foreground">¬∑</span>
                    <History className="h-3 w-3 text-green-500" />
                  </>
                )}
              </>
            )}
          </div>
          <div className="flex items-center gap-1">
            {!aiConfig.isConfigured && (
              <Button
                variant="ghost"
                size="sm"
                onClick={() => {
                  alert('ËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ AI ÊúçÂä°ÂïÜ„ÄÅAPI Key ÂíåÊ®°Âûã‰ø°ÊÅØ')
                }}
                className="h-6 w-6 p-0 macos-button flex-shrink-0"
                title="ÈÖçÁΩÆ AI"
              >
                <Settings className="h-3 w-3" />
              </Button>
            )}
            <Button
              variant="ghost"
              size="sm"
              onClick={clearChat}
              className="h-6 w-6 p-0 macos-button flex-shrink-0"
              title="Ê∏ÖÁ©∫ÂØπËØù"
            >
              <Trash2 className="h-3 w-3" />
            </Button>
            <Button
              variant="ghost"
              size="sm"
              onClick={onClose}
              className="h-6 w-6 p-0 macos-button flex-shrink-0"
              title="ÂÖ≥Èó≠"
            >
              <X className="h-3 w-3" />
            </Button>
          </div>
        </div>
      </div>

      {/* AI Áä∂ÊÄÅ - ÁÆÄÊ¥ÅÁâà */}
      {aiConfig.isConfigured && (
        <div className="px-2 py-1.5 text-xs text-muted-foreground bg-background/80 border-b border-border/30">
          <div className="flex items-center gap-1.5">
            <div className={`w-1.5 h-1.5 rounded-full ${isProcessingLongDoc ? 'bg-blue-500 animate-pulse' : 'bg-green-500'}`}></div>
            <span className="macos-text">
              {isProcessingLongDoc ? (
                <>
                  <Layers className="w-3 h-3 inline mr-1" />
                  ÈïøÊñáÊ°£Â§ÑÁêÜ‰∏≠ {processingProgress.total > 0 && `(${processingProgress.completed}/${processingProgress.total})`}
                </>
              ) : (
                <>
                  {aiConfig.provider === 'openai' && 'OpenAI'}
                  {aiConfig.provider === 'anthropic' && 'Anthropic'}
                  {aiConfig.provider === 'custom' && 'Ëá™ÂÆö‰πâ'}
                  {' ¬∑ '}
                  {aiConfig.model}
                  {currentDocument && currentDocument.content.length > 8000 && (
                    <> ¬∑ <Layers className="w-3 h-3 inline mx-1" />ÈïøÊñáÊ°£ÊîØÊåÅ</>
                  )}
                </>
              )}
            </span>
          </div>
        </div>
      )}

      {/* Ê∂àÊÅØÂå∫Âüü - ‰ΩøÁî®sidebar-scroll */}
      <div className="flex-1 overflow-y-auto sidebar-scroll">
        <div className="p-2 space-y-1">
          {displayMessages.length === 0 ? (
            <div className="flex flex-col items-center justify-center h-full text-center py-6">
              <div className="w-10 h-10 bg-muted/60 rounded-md flex items-center justify-center mb-3">
                <Bot className="h-5 w-5 text-muted-foreground" />
              </div>
              <h4 className="text-sm font-medium mb-1 macos-text">ÂºÄÂßãÂØπËØù</h4>
              <p className="text-xs text-muted-foreground mb-4 max-w-[220px] macos-text">
                {currentDocument
                  ? `Ê≠£Âú®ÂàÜÊûê "${currentDocument.fileName}"ÔºåÈóÆÊàëÁõ∏ÂÖ≥ÈóÆÈ¢ò„ÄÇ${
                      conversationStorage.loadConversation(currentDocument.filePath, currentDocument.fileName).length > 1
                        ? ' Â∑≤ÊÅ¢Â§çÂéÜÂè≤ÂØπËØù„ÄÇ'
                        : ''
                    }`
                  : 'ÊàëÂèØ‰ª•Â∏ÆÂä©ÊÇ®ÂàÜÊûêÊñáÊ°£ÂÜÖÂÆπÂíåÂõûÁ≠îÈóÆÈ¢ò„ÄÇ'}
              </p>
              {currentDocument && (
                <div className="w-full space-y-1">
                  <p className="text-xs font-medium text-muted-foreground macos-text">Âª∫ËÆÆÈóÆÈ¢òÔºö</p>
                  <div className="space-y-1 text-xs">
                    {(currentDocument && currentDocument.content.length > 8000 ? [
                      'üìÑ ÊÄªÁªìËøô‰∏™ÈïøÊñáÊ°£',
                      'üîç ÂàÜÊûêÊñáÊ°£ÁªìÊûÑ',
                      'üìã ÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØ',
                      'üí° Ëøô‰∏™ÊñáÊ°£ËÆ≤‰ªÄ‰πàÔºü'
                    ] : [
                      'Ëøô‰∏™ÊñáÊ°£ËÆ≤‰ªÄ‰πàÔºü',
                      'ÊÄªÁªì‰∏Ä‰∏ãË¶ÅÁÇπ',
                      'Ëß£ÈáäËøô‰∏™Ê¶ÇÂøµ'
                    ]).map((suggestion, index) => (
                      <Button
                        key={index}
                        variant="ghost"
                        size="sm"
                        className="justify-start h-7 px-2 py-1 w-full text-left transition-all duration-150 macos-file-item text-muted-foreground hover:text-foreground"
                        onClick={() => setInputValue(suggestion)}
                      >
                        <span className="truncate text-xs macos-text">{suggestion}</span>
                      </Button>
                    ))}
                  </div>
                </div>
              )}
            </div>
          ) : (
            <div className="space-y-1">
              {displayMessages.map((message) => (
                <div
                  key={message.id}
                  className={`flex gap-2 ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
                >
                  {message.role === 'assistant' && (
                    <div className="w-6 h-6 bg-primary/10 rounded-md flex items-center justify-center mt-0.5 flex-shrink-0">
                      <Bot className="h-3 w-3 text-primary" />
                    </div>
                  )}

                  <div className={`group flex flex-col max-w-[80%] ${message.role === 'user' ? 'items-end' : 'items-start'}`}>
                    <div
                      className={`rounded-lg px-3 py-2 text-xs macos-text leading-relaxed ${
                        message.role === 'user'
                          ? 'bg-primary text-primary-foreground'
                          : 'bg-background/80 border border-border/30 text-foreground'
                      }`}
                    >
                      <div className="whitespace-pre-wrap break-words">{message.content}</div>
                    </div>
                    <div className="flex items-center gap-1.5 mt-1 opacity-0 group-hover:opacity-100 transition-opacity duration-150">
                      <span className="text-xs text-muted-foreground font-mono">
                        {message.timestamp.toLocaleTimeString('zh-CN', {
                          hour: '2-digit',
                          minute: '2-digit'
                        })}
                      </span>
                      {message.role === 'assistant' && (
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => copyToClipboard(message.content, message.id)}
                          className="h-5 w-5 p-0 macos-button"
                        >
                          {copiedMessageId === message.id ? (
                            <Check className="h-2.5 w-2.5 text-green-500" />
                          ) : (
                            <Copy className="h-2.5 w-2.5" />
                          )}
                        </Button>
                      )}
                    </div>
                  </div>

                  {message.role === 'user' && (
                    <div className="w-6 h-6 bg-muted/60 rounded-md flex items-center justify-center mt-0.5 flex-shrink-0">
                      <User className="h-3 w-3 text-muted-foreground" />
                    </div>
                  )}
                </div>
              ))}

              {isLoading && (
                <div className="flex gap-2">
                  <div className="w-6 h-6 bg-primary/10 rounded-md flex items-center justify-center flex-shrink-0">
                    <Bot className="h-3 w-3 text-primary animate-pulse" />
                  </div>
                  <div className="bg-background/80 border border-border/30 rounded-lg px-3 py-2">
                    <div className="flex items-center gap-2">
                      <span className="text-xs text-muted-foreground macos-text">ÊÄùËÄÉ‰∏≠</span>
                      <div className="flex gap-0.5">
                        {[0, 1, 2].map((i) => (
                          <div
                            key={i}
                            className="w-1 h-1 bg-muted-foreground rounded-full animate-bounce"
                            style={{ animationDelay: `${i * 0.15}s` }}
                          />
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}
          <div ref={messagesEndRef} />
        </div>
      </div>

      {/* ËæìÂÖ•Âå∫Âüü - ‰∏éFileListÊêúÁ¥¢Ê°Ü‰øùÊåÅ‰∏ÄËá¥ */}
      <div className="px-2 py-2 border-t border-border/50 flex-shrink-0 bg-background/80">
        {!aiConfig.isConfigured && (
          <div className="mb-2 p-2 rounded-lg border border-border/30 bg-background/60">
            <div className="flex items-center gap-1.5">
              <Settings className="h-3 w-3 text-muted-foreground" />
              <p className="text-xs text-muted-foreground macos-text">
                ÈúÄË¶ÅÈÖçÁΩÆ AI ÊúçÂä°
              </p>
            </div>
          </div>
        )}
        <div className="flex items-center gap-1">
          <div className="relative flex-1">
            <Input
              ref={inputRef}
              placeholder={
                isProcessingLongDoc ? "ÈïøÊñáÊ°£Â§ÑÁêÜ‰∏≠..." :
                aiConfig.isConfigured ? "ËæìÂÖ•ÈóÆÈ¢ò..." : "ËØ∑ÂÖàÈÖçÁΩÆ AI ÊúçÂä°"
              }
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
              onKeyPress={handleKeyPress}
              disabled={isLoading || isProcessingLongDoc || !aiConfig.isConfigured}
              className="h-6 text-xs bg-background/50 border-border/30 focus:border-border/60"
            />
          </div>
          <Button
            onClick={sendMessage}
            disabled={!inputValue.trim() || isLoading || isProcessingLongDoc || !aiConfig.isConfigured}
            variant="ghost"
            size="sm"
            className="h-6 w-6 p-0 macos-button flex-shrink-0"
          >
            <Send className="h-3 w-3" />
          </Button>
        </div>
        {aiConfig.isConfigured && (
          <p className="mt-1.5 text-xs text-muted-foreground text-center macos-text">
            Enter ÂèëÈÄÅ ¬∑ Shift+Enter Êç¢Ë°å
          </p>
        )}
      </div>
    </div>
  )
}